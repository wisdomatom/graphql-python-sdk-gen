# output/selector.py
from __future__ import annotations
from dataclasses import dataclass, field
from typing import Any, Dict, List

@dataclass
class Field:
    name: str
    args: Dict[str, Any] = field(default_factory=dict)
    arg_types: Dict[str, str] = field(default_factory=dict)
    children: List["Field"] = field(default_factory=list)

    def to_graphql(self, indent: str = "", name_map: dict[str, str] = {}) -> str:
        s = indent + self.name
        if self.args:
            parts = []
            for k in self.args.keys():
                var_name = name_map.get(f"{self.name}.{k}")
                parts.append(f"{k}: ${var_name}")
            s += "(" + ", ".join(parts) + ")"
        if not self.children:
            return s + "\n"
        s += " {\n"
        for c in self.children:
            s += c.to_graphql(indent + "  ")
        s += indent + "}\n"
        return s


def _collect_vars(f: Field, vars: Dict[str, Any], var_types: Dict[str, str], name_map: Dict[str, str], counter: List[int]):
    if f is None:
        return
    for k, v in f.args.items():
        if v is None:
            continue
        counter[0] += 1
        var_name = f"{k}_{counter[0]}"
        name_map[f"{f.name}.{k}"] = var_name
        var_types[var_name] = f.arg_types.get(k, "")
        vars[var_name] = v
    for c in f.children:
        _collect_vars(c, vars, var_types, name_map, counter)


def build(field: Field, kind: str):
    vars = {}
    var_types = {}
    name_map = {}
    counter = [0]
    _collect_vars(field, vars, var_types, name_map, counter)

    keys = sorted(var_types.keys())
    parts = [f"${k}: {var_types[k]}" for k in keys]
    decl = ", ".join(parts)
    if decl:
        decl = "(" + decl + ")"

    body = field.to_graphql("  ", name_map)

    query = kind.lower() + decl + " {\n" + body + "}"
    return query, vars


# ---- SELECTOR CLASSES ----
{% for m in models %}
class {{ m["name"] }}Selector:
    def __init__(self, parent: str):
        self.field = Field(name=parent)

    def select(self, *fields):
        for f in fields:
            self.field.children.append(Field(name=f))
        return self

{% for f in m["fields"] %}
{% if f["is_object"] %}
    def {{ f["name"] }}(self, selector_fn=None):
        if selector_fn is None:
            self.field.children.append(Field(name="{{ f["name"] }}"))
            return self

        # list or non-list is handled the same: use raw GraphQL type
        sel = {{ f["gql_type"] }}Selector("{{ f["name"] }}")
        selector_fn(sel)
        self.field.children.append(sel.field)
        return self

{% else %}
    # Scalar field
    def {{ f["name"] }}(self):
        self.field.children.append(Field(name="{{ f["name"] }}"))
        return self

{% endif %}
{% endfor %}

    def get_field(self):
        return self.field

{% endfor %}
